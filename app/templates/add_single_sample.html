<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Single Sample - Admin System</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cropper.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        :root {
            --primary-blue: #1a3a5f;
            --dark-blue: #0a1f33;
            --accent-blue: #2c5282;
            --light-blue: #4a90e2;
            --sidebar-width: 280px;
            --sidebar-collapsed: 80px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        #sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
        }
        
        #sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }
        
        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .sidebar-header .logo {
            height: 40px;
            margin-bottom: 0.5rem;
        }
        
        #sidebar.collapsed .sidebar-header h3,
        #sidebar.collapsed .sidebar-header p {
            display: none;
        }
        
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        .menu-item {
            padding: 0.85rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 4px solid var(--light-blue);
        }
        
        .menu-item i {
            margin-right: 1rem;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        .left-section {
            display: flex;
            align-items: center;  /* căn cùng hàng ngang */
            gap: 20px;            /* khoảng cách giữa nút và chữ */
        }
        
        #sidebar.collapsed .menu-item span {
            display: none;
        }
        
        #sidebar.collapsed .menu-item i {
            margin-right: 0;
        }
        
        /* Main Content Styles */
        #content {
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
            min-height: 100vh;
        }
        
        #content.expanded {
            margin-left: var(--sidebar-collapsed);
        }
        
        .top-navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toggle-sidebar {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-blue);
            cursor: pointer;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--light-blue), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        /* Add Single Sample Styles */
        .page-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .page-title {
            color: var(--primary-blue);
            font-weight: 700;
            margin: 0;
        }
        
        .sample-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .step-indicator {
            display: flex;
            margin-bottom: 2rem;
            justify-content: center;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 150px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
        }
        
        .step-label {
            font-size: 0.85rem;
            text-align: center;
            color: #6c757d;
            font-weight: 600;
        }
        
        .step.active .step-label {
            color: var(--primary-blue);
        }
        
        .step-line {
            flex: 1;
            height: 2px;
            background-color: #e9ecef;
            margin: 20px 10px 0;
        }
        
        .step-content {
            display: block;
        }
        
        .step-content.d-none {
            display: none !important;
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }
        
        .form-control, .form-select, .form-textarea {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--light-blue);
            box-shadow: 0 0 0 0.2rem rgba(42, 128, 255, 0.25);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: var(--light-blue);
            background: #f0f8ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--light-blue);
            margin-bottom: 1rem;
        }
        
        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .preview-container {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 1rem;
            background: #fdfdfd;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .preview-container img, .preview-container video {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }
        
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #f1f3f4;
        }
        
        .crop-preview {
            width: 200px;
            height: 150px;
            overflow: hidden;
            border-radius: 8px;
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--primary-blue);
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            display: inline-block;
        }
        
        .trim-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }
        
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 5;
            display: none;
        }
        
        .crop-area {
            position: absolute;
            border: 2px dashed #ff0000;
            background: rgba(255,0,0,0.1);
            cursor: move;
            z-index: 6;
        }
        
        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff0000;
            border: 1px solid white;
            border-radius: 50%;
        }
        
        .handle-nw { top: -5px; left: -5px; cursor: nw-resize; }
        .handle-ne { top: -5px; right: -5px; cursor: ne-resize; }
        .handle-sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .handle-se { bottom: -5px; right: -5px; cursor: se-resize; }
        
        .video-crop-instruction {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 7;
            display: none;
        }
        
        .preview-with-crop {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        
        .crop-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .crop-preview-area {
            position: absolute;
            border: 3px solid #00ff00;
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        
        .crop-preview-info {
            position: absolute;
            top: -30px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .preview-dimmed {
            filter: brightness(0.6);
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #f1f3f4;
        }
        
        .btn-back {
            background: linear-gradient(135deg, #6c757d, #545b62);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-next {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-back:hover, .btn-next:hover, .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .range-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .range-controls input[type="range"] {
            flex: 1;
        }
        
        .time-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .time-inputs .input-group {
            flex: 1;
        }
        
        .alert-custom {
            border-radius: 12px;
            border: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            #sidebar {
                width: var(--sidebar-collapsed);
            }
            
            #sidebar.collapsed {
                width: 0;
            }
            
            #content {
                margin-left: var(--sidebar-collapsed);
            }
            
            #content.expanded {
                margin-left: 0;
            }
            
            .step-indicator {
                flex-direction: column;
                gap: 1rem;
            }
            
            .step-line {
                display: none;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <img src="/static/images/facial-recognition.png" alt="Logo" class="logo">
            <h3>Admin System</h3>
            <p class="mb-0">Management Portal</p>
        </div>
        
        <div class="sidebar-menu">
            <a href="/" class="menu-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="/manage_samples" class="menu-item">
                <i class="fas fa-vial"></i>
                <span>Manage Samples</span>
            </a>
            <a href="/manage_user" class="menu-item">
                <i class="fas fa-users"></i>
                <span>Manage Users</span>
            </a>
            <a href="/train" class="menu-item">
                <i class="fas fa-brain"></i>
                <span>Training</span>
            </a>
            <a href="/manage-test-results" class="menu-item">
                <i class="fas fa-chart-bar"></i>
                <span>Test Results</span>
            </a>
            <a href="/view_feedback" class="menu-item">
                <i class="fas fa-comments"></i>
                <span>Feedback</span>
            </a>
            <a href="/settings" class="menu-item">
                <i class="fas fa-cogs"></i>
                <span>System Settings</span>
            </a>
            <a href="/logout" class="menu-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>
    
    <!-- Main Content -->
    <div id="content">
        <!-- Top Navbar -->
        <div class="top-navbar">
             <div class="left-section">
                    <button class="toggle-sidebar" id="toggleSidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                        <h3 class="page-title"><i class="fas fa-plus-circle me-2"></i>Add Single Sample</h3>
                </div>
                
            
            <div class="user-info">
                <div class="user-avatar">
                    {{ username|first|upper }}
                </div>
                <div>
                    <strong>{{ username }}</strong>
                    <div class="text-muted" style="font-size: 0.85rem;">Administrator</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Page Header -->
            <!-- <div class="page-header">
                <h1 class="page-title"><i class="fas fa-plus-circle me-2"></i>Add Single Sample</h1>
            </div> -->
            
            <!-- Sample Card -->
            <div class="sample-card">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-label">File Details</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-label">Crop & Trim</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-label">Preview & Save</div>
                    </div>
                </div>

                <form id="singleForm" method="post" action="/add_single_sample" enctype="multipart/form-data">
                    <!-- Step 1: File Details -->
                    <div class="step-content" id="step1-content">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-section">
                                    <h5><i class="fas fa-info-circle me-2"></i>Sample Information</h5>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Type</label>
                                        <select class="form-select" id="typeSelect" name="type" required>
                                            <option value="">-- Select Type --</option>
                                            <option value="image">Image</option>
                                            <option value="video">Video</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Label</label>
                                        <select class="form-select" name="label" required>
                                            <option value="real">Real</option>
                                            <option value="fake">Fake</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control form-textarea" name="description" rows="3" placeholder="Source: ..." id="descriptionInput"></textarea>
                                        <div class="form-text text-muted">Provide details about the sample source and characteristics</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-section">
                                    <h5><i class="fas fa-upload me-2"></i>File Upload</h5>
                                    
                                    <div class="file-upload-area" id="dropZone">
                                        <div class="upload-icon">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                        </div>
                                        <h5>Drop your file here or click to browse</h5>
                                        <p class="text-muted">Supports images and videos</p>
                                        <input type="file" id="fileInput" name="file" class="d-none" accept="image/*,video/*" required>
                                        <button type="button" class="btn btn-outline-primary mt-2" id="browseBtn">
                                            <i class="fas fa-folder-open me-2"></i>Browse Files
                                        </button>
                                    </div>
                                    
                                    <div class="file-info d-none" id="fileInfo">
                                        <div class="d-flex justify-content-between">
                                            <span><strong>File:</strong> <span id="fileName"></span></span>
                                            <span><strong>Size:</strong> <span id="fileSize"></span></span>
                                        </div>
                                        <div class="mt-1">
                                            <span><strong>Type:</strong> <span id="fileType"></span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-back" onclick="history.back()">
                                <i class="fas fa-arrow-left me-2"></i>Back to Samples
                            </button>
                            <button type="button" class="btn btn-next" id="nextStep1">
                                Next <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Crop & Trim -->
                    <div class="step-content d-none" id="step2-content">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="preview-container" id="preview-container">
                                    <p class="text-muted">Preview will appear here</p>
                                </div>
                                
                                <!-- Video Crop Overlay -->
                                <div id="video-crop-overlay" class="crop-overlay">
                                    <div class="video-crop-instruction" id="cropInstruction">
                                        Drag to move, drag handles to resize
                                    </div>
                                    <div id="cropArea" class="crop-area" style="display: none;">
                                        <div class="crop-handle handle-nw"></div>
                                        <div class="crop-handle handle-ne"></div>
                                        <div class="crop-handle handle-sw"></div>
                                        <div class="crop-handle handle-se"></div>
                                    </div>
                                </div>
                                
                                <!-- Video Controls Overlay -->
                                <div id="video-overlay" class="trim-overlay d-none">
                                    <div>
                                        <span>Start: <span id="currentStartTime">0</span>s</span> - 
                                        <span>End: <span id="currentEndTime">0</span>s</span>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-light" id="playTrim">
                                            <i class="fas fa-play"></i> Play Trim
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="control-panel">
                                    <h5><i class="fas fa-crop-alt me-2"></i>Crop Controls</h5>
                                    
                                    <!-- Image Crop Controls -->
                                    <div id="image-controls" class="d-none">
                                        <p class="text-muted small mb-3">Drag to select crop area on the image</p>
                                        
                                        <div class="mb-2">
                                            <label class="form-label small">Position: <span id="cropPos">0,0</span></label>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label class="form-label small">Size: <span id="cropSize">0x0</span></label>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="resetCrop">
                                                <i class="fas fa-redo me-1"></i> Reset Crop
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Video Controls -->
                                    <div id="video-controls" class="d-none">
                                        <h6><i class="fas fa-film me-2"></i>Video Controls</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Trim Video</label>
                                            <div class="time-inputs">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">Start (s)</span>
                                                    <input type="number" id="startTime" class="form-control" placeholder="0" min="0" step="0.1" value="0">
                                                </div>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">End (s)</span>
                                                    <input type="number" id="endTime" class="form-control" placeholder="0" min="0" step="0.1" value="0">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Timeline</label>
                                            <div class="range-controls">
                                                <span class="small">0s</span>
                                                <input type="range" id="startRange" min="0" step="0.1" value="0" class="form-range">
                                                <input type="range" id="endRange" min="0" step="0.1" value="0" class="form-range">
                                                <span class="small" id="maxDuration">0s</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Video Crop</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="enableVideoCrop">
                                                <label class="form-check-label" for="enableVideoCrop">
                                                    Enable frame cropping
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div id="video-crop-controls" class="d-none">
                                            <div class="mb-2">
                                                <label class="form-label small">Crop Area: <span id="videoCropSize">0x0</span></label>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="resetVideoCrop">
                                                    <i class="fas fa-crop me-1"></i> Reset Video Crop
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Crop Preview -->
                                <div class="preview-section mt-3">
                                    <h6><i class="fas fa-eye me-2"></i>Crop Preview</h6>
                                    <div class="crop-preview" id="cropPreview">
                                        <span class="text-muted small">Preview will appear here</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-back" id="prevStep2">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-next" id="nextStep2">
                                Next <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Preview & Save -->
                    <div class="step-content d-none" id="step3-content">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-section">
                                    <h5><i class="fas fa-info-circle me-2"></i>Sample Details</h5>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Type</strong></label>
                                        <p id="previewType" class="form-control-plaintext">-</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Label</strong></label>
                                        <p id="previewLabel" class="form-control-plaintext">-</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Description</strong></label>
                                        <p id="previewDescription" class="form-control-plaintext">-</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Crop Data</strong></label>
                                        <pre id="previewCropData" class="bg-light p-2 rounded small">-</pre>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-section">
                                    <h5><i class="fas fa-file me-2"></i>Final Preview</h5>
                                    
                                    <div class="preview-container" id="finalPreviewContainer">
                                        <div class="preview-with-crop" id="finalPreviewWrapper">
                                            <div id="finalPreview">
                                                <p class="text-muted">Final preview will appear here</p>
                                            </div>
                                            <div class="crop-preview-overlay" id="cropPreviewOverlay"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2 text-center">
                                        <small class="text-muted">Green area shows the selected crop region</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-back" id="prevStep3">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-save me-2"></i>Save Sample
                            </button>
                        </div>
                    </div>

                    <input type="hidden" name="crop_data" id="cropData">
                </form>
                
                <!-- Success/Error Message -->
                {% if message %}
                <div class="alert alert-info alert-custom mt-4 text-center">
                    <i class="fas fa-info-circle me-2"></i>{{ message }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Toggle sidebar
        document.getElementById('toggleSidebar').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            
            // Change icon
            const icon = this.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-indent');
            } else {
                icon.classList.remove('fa-indent');
                icon.classList.add('fa-bars');
            }
        });
        
        // Set active menu item
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.menu-item').forEach(i => {
                    i.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

        // ... (Tất cả JavaScript code từ phiên bản trước giữ nguyên)
        // DOM Elements và toàn bộ logic JavaScript từ code trước
        // ... (giữ nguyên toàn bộ JavaScript)
           // DOM Elements
      // DOM Elements
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const dropZone = document.getElementById('dropZone');
    const previewContainer = document.getElementById('preview-container');
    const typeSelect = document.getElementById('typeSelect');
    const videoControls = document.getElementById('video-controls');
    const imageControls = document.getElementById('image-controls');
    const cropDataInput = document.getElementById('cropData');
    const messageBox = document.getElementById('messageBox');
    const startTime = document.getElementById('startTime');
    const endTime = document.getElementById('endTime');
    const startRange = document.getElementById('startRange');
    const endRange = document.getElementById('endRange');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');
    const finalPreview = document.getElementById('finalPreview');
    const finalPreviewWrapper = document.getElementById('finalPreviewWrapper');
    const cropPreviewOverlay = document.getElementById('cropPreviewOverlay');
    const previewType = document.getElementById('previewType');
    const previewLabel = document.getElementById('previewLabel');
    const previewDescription = document.getElementById('previewDescription');
    const previewCropData = document.getElementById('previewCropData');
    const videoOverlay = document.getElementById('video-overlay');
    const currentStartTime = document.getElementById('currentStartTime');
    const currentEndTime = document.getElementById('currentEndTime');
    const playTrimBtn = document.getElementById('playTrim');
    const enableVideoCrop = document.getElementById('enableVideoCrop');
    const videoCropControls = document.getElementById('video-crop-controls');
    const videoCropSize = document.getElementById('videoCropSize');
    const resetVideoCropBtn = document.getElementById('resetVideoCrop');
    const cropPos = document.getElementById('cropPos');
    const cropSize = document.getElementById('cropSize');
    const maxDuration = document.getElementById('maxDuration');
    const videoCropOverlay = document.getElementById('video-crop-overlay');
    const cropArea = document.getElementById('cropArea');
    const cropInstruction = document.getElementById('cropInstruction');
    const cropPreview = document.getElementById('cropPreview');
    
    // Step navigation elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step1Content = document.getElementById('step1-content');
    const step2Content = document.getElementById('step2-content');
    const step3Content = document.getElementById('step3-content');
    const nextStep1 = document.getElementById('nextStep1');
    const nextStep2 = document.getElementById('nextStep2');
    const prevStep2 = document.getElementById('prevStep2');
    const prevStep3 = document.getElementById('prevStep3');
    
    // Global variables
    let cropper = null;
    let currentVideo = null;
    let currentFile = null;
    let currentFileUrl = null;
    let cropData = {
      x: 0,
      y: 0,
      x2: 0,
      y2: 0,
      width: 0,
      height: 0,
      start: 0,
      end: 0
    };
    let videoDuration = 0;
    let isCroppingVideo = false;
    let isDragging = false;
    let isResizing = false;
    let dragStartX, dragStartY;
    let cropStartX, cropStartY, cropStartWidth, cropStartHeight;
    let resizeStartX, resizeStartY;

    // Event Listeners
    browseBtn.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#4361ee';
      dropZone.style.backgroundColor = '#f0f4ff';
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '#dee2e6';
      dropZone.style.backgroundColor = '#fdfdfd';
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#dee2e6';
      dropZone.style.backgroundColor = '#fdfdfd';
      
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelection();
      }
    });

    fileInput.addEventListener('change', handleFileSelection);
    
    // Step Navigation
    nextStep1.addEventListener('click', () => {
      if (!currentFile) {
        alert('Please select a file first');
        return;
      }
      
      if (!typeSelect.value) {
        alert('Please select a file type');
        return;
      }
      
      step1.classList.remove('active');
      step2.classList.add('active');
      step1Content.classList.add('d-none');
      step2Content.classList.remove('d-none');
      
      loadPreview();
    });
    
    nextStep2.addEventListener('click', () => {
      updatePreviewStep();
      
      step2.classList.remove('active');
      step3.classList.add('active');
      step2Content.classList.add('d-none');
      step3Content.classList.remove('d-none');
    });
    
    prevStep2.addEventListener('click', () => {
      step2.classList.remove('active');
      step1.classList.add('active');
      step2Content.classList.add('d-none');
      step1Content.classList.remove('d-none');
    });
    
    prevStep3.addEventListener('click', () => {
      step3.classList.remove('active');
      step2.classList.add('active');
      step3Content.classList.add('d-none');
      step2Content.classList.remove('d-none');
    });

    // File handling
    function handleFileSelection() {
      const file = fileInput.files[0];
      console.log('Selected file:', file);
      if (!file) return;
      
      currentFile = file;
      currentFileUrl = URL.createObjectURL(file);
      
      // Auto-detect type if not set
      if (!typeSelect.value) {
        if (file.type.startsWith('image/')) {
          typeSelect.value = 'image';
        } else if (file.type.startsWith('video/')) {
          typeSelect.value = 'video';
        }
      }
      
      // Update file info
      fileInfo.classList.remove('d-none');
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileType.textContent = file.type.split('/')[1].toUpperCase();
      
      // Update dropzone text
      dropZone.innerHTML = `
        <i class="fas fa-file-${file.type.includes('image') ? 'image' : 'video'} fa-2x text-primary mb-2"></i>
        <p class="mb-1"><strong>${file.name}</strong></p>
        <p class="text-muted small">${formatFileSize(file.size)} • ${file.type.split('/')[1].toUpperCase()}</p>
        <button type="button" class="btn btn-outline-secondary btn-sm mt-1" id="changeFileBtn">Change File</button>
      `;
      
      document.getElementById('changeFileBtn').addEventListener('click', () => {
        fileInput.click();
      });
    }

    function loadPreview() {
      previewContainer.innerHTML = '';
      videoControls.classList.add('d-none');
      imageControls.classList.add('d-none');
      videoOverlay.classList.add('d-none');
      videoCropOverlay.style.display = 'none';
      cropArea.style.display = 'none';
      cropInstruction.style.display = 'none';
      
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }

      if (!currentFile) return;
      
      const type = typeSelect.value;

      // Image
      if (type === 'image') {
        imageControls.classList.remove('d-none');
        
        const img = document.createElement('img');
        img.src = currentFileUrl;
        img.id = 'imageToCrop';
        previewContainer.appendChild(img);
        
        img.addEventListener('load', () => {
          // Initialize crop data with full image
          cropData = {
            x: 0,
            y: 0,
            x2: img.naturalWidth,
            y2: img.naturalHeight,
            width: img.naturalWidth,
            height: img.naturalHeight,
            start: 0,
            end: 0
          };
          
          updateCropDisplay();
          updateCropPreview();
          
          cropper = new Cropper(img, {
            viewMode: 1,
            movable: true,
            zoomable: true,
            scalable: true,
            crop(event) {
              cropData = {
                x: Math.round(event.detail.x),
                y: Math.round(event.detail.y),
                x2: Math.round(event.detail.x + event.detail.width),
                y2: Math.round(event.detail.y + event.detail.height),
                width: Math.round(event.detail.width),
                height: Math.round(event.detail.height),
                start: 0,
                end: 0
              };
              
              updateCropDisplay();
              updateCropPreview();
            }
          });
        });
      }

      // Video
      else if (type === 'video') {
        videoControls.classList.remove('d-none');
        videoOverlay.classList.remove('d-none');
        
        const videoWrapper = document.createElement('div');
        videoWrapper.className = 'video-wrapper';
        
        const video = document.createElement('video');
        video.src = currentFileUrl;
        video.controls = true;
        video.muted = true;
        video.id = 'videoToTrim';
        videoWrapper.appendChild(video);
        previewContainer.appendChild(videoWrapper);
        previewContainer.appendChild(videoCropOverlay);
        previewContainer.appendChild(videoOverlay);
        
        currentVideo = video;

        video.addEventListener('loadedmetadata', () => {
          videoDuration = video.duration;
          const duration = videoDuration.toFixed(1);
          
          startRange.max = duration;
          endRange.max = duration;
          endRange.value = duration;
          endTime.value = duration;
          maxDuration.textContent = `${duration}s`;
          
          // Initialize crop data with full video and duration
          cropData = {
            x: 0,
            y: 0,
            x2: video.videoWidth,
            y2: video.videoHeight,
            width: video.videoWidth,
            height: video.videoHeight,
            start: 0,
            end: parseFloat(duration)
          };
          
          updateVideoOverlay();
          updateCropPreview();
          
          // Initialize crop area for video
          initVideoCrop();
        });
        
        video.addEventListener('timeupdate', () => {
          if (video.currentTime >= cropData.end) {
            video.pause();
          }
        });
      }
    }

    // NEW: Function to update crop overlay in final preview
    function updateCropOverlay() {
      const type = typeSelect.value;
      cropPreviewOverlay.innerHTML = '';
      
      if (type === 'image') {
        const img = finalPreview.querySelector('img');
        if (!img) return;
        
        // Wait for image to load
        img.onload = function() {
          const imgRect = img.getBoundingClientRect();
          const containerRect = finalPreviewWrapper.getBoundingClientRect();
          
          // Calculate scale factors
          const scaleX = imgRect.width / img.naturalWidth;
          const scaleY = imgRect.height / img.naturalHeight;
          
          // Calculate crop area position and size
          const cropX = cropData.x * scaleX;
          const cropY = cropData.y * scaleY;
          const cropWidth = cropData.width * scaleX;
          const cropHeight = cropData.height * scaleY;
          
          // Create crop overlay
          const cropOverlay = document.createElement('div');
          cropOverlay.className = 'crop-preview-area';
          cropOverlay.style.left = cropX + 'px';
          cropOverlay.style.top = cropY + 'px';
          cropOverlay.style.width = cropWidth + 'px';
          cropOverlay.style.height = cropHeight + 'px';
          
          // Create info label
          const infoLabel = document.createElement('div');
          infoLabel.className = 'crop-preview-info';
          infoLabel.textContent = `${cropData.width} × ${cropData.height}`;
          infoLabel.style.left = cropX + 'px';
          infoLabel.style.top = (cropY - 25) + 'px';
          
          cropPreviewOverlay.appendChild(cropOverlay);
          cropPreviewOverlay.appendChild(infoLabel);
          
          // Dim the area outside crop
          img.classList.add('preview-dimmed');
        };
        
        // Trigger load if image is already loaded
        if (img.complete) {
          img.onload();
        }
        
      } else if (type === 'video') {
        const video = finalPreview.querySelector('video');
        if (!video) return;
        
        video.onloadedmetadata = function() {
          const videoRect = video.getBoundingClientRect();
          const containerRect = finalPreviewWrapper.getBoundingClientRect();
          
          // Calculate scale factors
          const scaleX = videoRect.width / video.videoWidth;
          const scaleY = videoRect.height / video.videoHeight;
          
          if (isCroppingVideo) {
            // Calculate crop area position and size
            const cropX = cropData.x * scaleX;
            const cropY = cropData.y * scaleY;
            const cropWidth = cropData.width * scaleX;
            const cropHeight = cropData.height * scaleY;
            
            // Create crop overlay
            const cropOverlay = document.createElement('div');
            cropOverlay.className = 'crop-preview-area';
            cropOverlay.style.left = cropX + 'px';
            cropOverlay.style.top = cropY + 'px';
            cropOverlay.style.width = cropWidth + 'px';
            cropOverlay.style.height = cropHeight + 'px';
            
            // Create info label
            const infoLabel = document.createElement('div');
            infoLabel.className = 'crop-preview-info';
            infoLabel.textContent = `${cropData.width} × ${cropData.height}`;
            infoLabel.style.left = cropX + 'px';
            infoLabel.style.top = (cropY - 25) + 'px';
            
            cropPreviewOverlay.appendChild(cropOverlay);
            cropPreviewOverlay.appendChild(infoLabel);
            
            // Dim the area outside crop
            video.classList.add('preview-dimmed');
          }
          
          // Add trim info
          const trimInfo = document.createElement('div');
          trimInfo.className = 'crop-preview-info';
          trimInfo.style.top = '10px';
          trimInfo.style.left = '10px';
          trimInfo.textContent = `Trim: ${cropData.start.toFixed(1)}s - ${cropData.end.toFixed(1)}s`;
          cropPreviewOverlay.appendChild(trimInfo);
        };
        
        // Trigger load if video metadata is already loaded
        if (video.readyState >= 1) {
          video.onloadedmetadata();
        }
      }
    }

    // Initialize video crop functionality
    function initVideoCrop() {
      if (!currentVideo) return;
      
      // Show crop overlay when enabled
      enableVideoCrop.addEventListener('change', function() {
        isCroppingVideo = this.checked;
        videoCropControls.classList.toggle('d-none', !isCroppingVideo);
        videoCropOverlay.style.display = isCroppingVideo ? 'block' : 'none';
        cropInstruction.style.display = isCroppingVideo ? 'block' : 'none';
        
        if (isCroppingVideo) {
          // Initialize crop area
          const videoRect = currentVideo.getBoundingClientRect();
          const containerRect = previewContainer.getBoundingClientRect();
          
          // Set initial crop area (80% of video size, centered)
          const cropWidth = videoRect.width * 0.8;
          const cropHeight = videoRect.height * 0.8;
          const cropX = (videoRect.width - cropWidth) / 2;
          const cropY = (videoRect.height - cropHeight) / 2;
          
          cropArea.style.width = cropWidth + 'px';
          cropArea.style.height = cropHeight + 'px';
          cropArea.style.left = cropX + 'px';
          cropArea.style.top = cropY + 'px';
          cropArea.style.display = 'block';
          
          // Calculate actual pixel coordinates relative to video
          const scaleX = currentVideo.videoWidth / videoRect.width;
          const scaleY = currentVideo.videoHeight / videoRect.height;
          
          cropData = {
            ...cropData,
            x: Math.round(cropX * scaleX),
            y: Math.round(cropY * scaleY),
            x2: Math.round((cropX + cropWidth) * scaleX),
            y2: Math.round((cropY + cropHeight) * scaleY),
            width: Math.round(cropWidth * scaleX),
            height: Math.round(cropHeight * scaleY)
          };
          
          updateCropDisplay();
          updateCropPreview();
          
          // Add event listeners for crop area
          setupCropAreaEvents();
        } else {
          cropArea.style.display = 'none';
          // Reset crop data
          cropData = {
            ...cropData,
            x: 0,
            y: 0,
            x2: currentVideo.videoWidth,
            y2: currentVideo.videoHeight,
            width: currentVideo.videoWidth,
            height: currentVideo.videoHeight
          };
          updateCropPreview();
        }
      });
    }

    // Setup crop area drag and resize events
    function setupCropAreaEvents() {
      const handles = cropArea.querySelectorAll('.crop-handle');
      
      // Mouse down on crop area (for dragging)
      cropArea.addEventListener('mousedown', startDrag);
      cropArea.addEventListener('touchstart', startDrag);
      
      // Mouse down on handles (for resizing)
      handles.forEach(handle => {
        handle.addEventListener('mousedown', startResize);
        handle.addEventListener('touchstart', startResize);
      });
      
      // Global mouse events
      document.addEventListener('mousemove', doDragResize);
      document.addEventListener('touchmove', doDragResize);
      document.addEventListener('mouseup', stopDragResize);
      document.addEventListener('touchend', stopDragResize);
    }

    function startDrag(e) {
      if (!isCroppingVideo) return;
      e.preventDefault();
      isDragging = true;
      
      const rect = cropArea.getBoundingClientRect();
      dragStartX = (e.clientX || e.touches[0].clientX) - rect.left;
      dragStartY = (e.clientY || e.touches[0].clientY) - rect.top;
      
      cropArea.style.cursor = 'grabbing';
    }

    function startResize(e) {
      if (!isCroppingVideo) return;
      e.preventDefault();
      e.stopPropagation();
      isResizing = true;

      const rect = cropArea.getBoundingClientRect();
      const containerRect = previewContainer.getBoundingClientRect();
      
      // Ghi lại vị trí crop tương đối trong container
      cropStartX = rect.left - containerRect.left;
      cropStartY = rect.top - containerRect.top;
      cropStartWidth = rect.width;
      cropStartHeight = rect.height;

      // Ghi lại vị trí chuột ban đầu
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      resizeStartX = clientX - containerRect.left;
      resizeStartY = clientY - containerRect.top;
        
      this.setAttribute('data-resize', this.className.includes('nw') ? 'nw' : 
                       this.className.includes('ne') ? 'ne' :
                       this.className.includes('sw') ? 'sw' : 'se');
    }

    function doDragResize(e) {
      if (!isDragging && !isResizing) return;
      e.preventDefault();
      
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      
      if (isDragging) {
        // Dragging the entire crop area
        const containerRect = previewContainer.getBoundingClientRect();
        const videoRect = currentVideo.getBoundingClientRect();
        
        let newX = clientX - containerRect.left - dragStartX;
        let newY = clientY - containerRect.top - dragStartY;
        
        // Constrain to video bounds
        newX = Math.max(0, Math.min(newX, videoRect.width - cropArea.offsetWidth));
        newY = Math.max(0, Math.min(newY, videoRect.height - cropArea.offsetHeight));
        
        cropArea.style.left = newX + 'px';
        cropArea.style.top = newY + 'px';
        
        // Update crop data
        const scaleX = currentVideo.videoWidth / videoRect.width;
        const scaleY = currentVideo.videoHeight / videoRect.height;
        
        cropData.x = Math.round(newX * scaleX);
        cropData.y = Math.round(newY * scaleY);
        cropData.x2 = Math.round((newX + cropArea.offsetWidth) * scaleX);
        cropData.y2 = Math.round((newY + cropArea.offsetHeight) * scaleY);
        cropData.width = Math.round(cropArea.offsetWidth * scaleX);
        cropData.height = Math.round(cropArea.offsetHeight * scaleY);
        
      } else if (isResizing) {
        // Resizing the crop area
        const handleType = document.querySelector('.crop-handle[data-resize]').getAttribute('data-resize');
        const containerRect = previewContainer.getBoundingClientRect();
        const videoRect = currentVideo.getBoundingClientRect();

        // Tính toạ độ chuột tương đối trong container
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        const relativeX = clientX - containerRect.left;
        const relativeY = clientY - containerRect.top;
        let newX = cropStartX;
        let newY = cropStartY;
        let newWidth = cropStartWidth;
        let newHeight = cropStartHeight;
        
        const deltaX = relativeX - resizeStartX;
        const deltaY = relativeY - resizeStartY;
        
        switch (handleType) {
          case 'nw':
            newX = cropStartX + deltaX;
            newY = cropStartY + deltaY;
            newWidth = cropStartWidth - deltaX;
            newHeight = cropStartHeight - deltaY;
            break;
          case 'ne':
            newY = cropStartY + deltaY;
            newWidth = cropStartWidth + deltaX;
            newHeight = cropStartHeight - deltaY;
            break;
          case 'sw':
            newX = cropStartX + deltaX;
            newWidth = cropStartWidth - deltaX;
            newHeight = cropStartHeight + deltaY;
            break;
          case 'se':
            newWidth = cropStartWidth + deltaX;
            newHeight = cropStartHeight + deltaY;
            break;
        }
        
        // Constrain minimum size and bounds
        const minSize = 50;
        newWidth = Math.max(minSize, Math.min(newWidth, videoRect.width - newX));
        newHeight = Math.max(minSize, Math.min(newHeight, videoRect.height - newY));
        newX = Math.max(0, Math.min(newX, videoRect.width - minSize));
        newY = Math.max(0, Math.min(newY, videoRect.height - minSize));
        
        cropArea.style.left = newX + 'px';
        cropArea.style.top = newY + 'px';
        cropArea.style.width = newWidth + 'px';
        cropArea.style.height = newHeight + 'px';
        
        // Update crop data
        const scaleX = currentVideo.videoWidth / videoRect.width;
        const scaleY = currentVideo.videoHeight / videoRect.height;
        
        cropData.x = Math.round(newX * scaleX);
        cropData.y = Math.round(newY * scaleY);
        cropData.x2 = Math.round((newX + newWidth) * scaleX);
        cropData.y2 = Math.round((newY + newHeight) * scaleY);
        cropData.width = Math.round(newWidth * scaleX);
        cropData.height = Math.round(newHeight * scaleY);
      }
      
      updateCropDisplay();
      updateCropPreview();
    }

    function stopDragResize() {
      isDragging = false;
      isResizing = false;
      cropArea.style.cursor = 'move';
      
      // Remove resize data attribute
      const resizeHandle = document.querySelector('.crop-handle[data-resize]');
      if (resizeHandle) {
        resizeHandle.removeAttribute('data-resize');
      }
    }

    // Link range and number inputs for video
    startRange.addEventListener('input', () => {
      startTime.value = startRange.value;
      cropData.start = parseFloat(startRange.value);
      updateVideoOverlay();
      updateCropPreview();
    });
    
    endRange.addEventListener('input', () => {
      endTime.value = endRange.value;
      cropData.end = parseFloat(endRange.value);
      updateVideoOverlay();
      updateCropPreview();
    });
    
    startTime.addEventListener('input', () => {
      startRange.value = startTime.value;
      cropData.start = parseFloat(startTime.value);
      updateVideoOverlay();
      updateCropPreview();
    });
    
    endTime.addEventListener('input', () => {
      endRange.value = endTime.value;
      cropData.end = parseFloat(endTime.value);
      updateVideoOverlay();
      updateCropPreview();
    });

    // Update video overlay
    function updateVideoOverlay() {
      currentStartTime.textContent = cropData.start.toFixed(1);
      currentEndTime.textContent = cropData.end.toFixed(1);
    }

    // Update crop display
    function updateCropDisplay() {
      if (typeSelect.value === 'image') {
        cropPos.textContent = `${cropData.x},${cropData.y}`;
        cropSize.textContent = `${cropData.width}x${cropData.height}`;
      } else if (typeSelect.value === 'video' && isCroppingVideo) {
        videoCropSize.textContent = `${cropData.width}x${cropData.height}`;
      }
    }

    // Update crop preview
    function updateCropPreview() {
      const type = typeSelect.value;
      
      cropPreview.innerHTML = '';
      
      if (type === 'image') {
        // Create a representation of the cropped area
        const previewCanvas = document.createElement('canvas');
        const ctx = previewCanvas.getContext('2d');
        
        // Set canvas size proportional to crop area but max 200x150
        const scale = Math.min(200 / cropData.width, 150 / cropData.height, 1);
        previewCanvas.width = cropData.width * scale;
        previewCanvas.height = cropData.height * scale;
        
        ctx.fillStyle = '#e9ecef';
        ctx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
        
        ctx.strokeStyle = '#4361ee';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, previewCanvas.width, previewCanvas.height);
        
        ctx.fillStyle = '#4361ee';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${cropData.width} x ${cropData.height}`, previewCanvas.width/2, previewCanvas.height/2);
        
        cropPreview.appendChild(previewCanvas);
        
      } else if (type === 'video') {
        const previewContent = document.createElement('div');
        previewContent.className = 'text-center p-2';
        
        const icon = document.createElement('i');
        icon.className = 'fas fa-video text-muted mb-2';
        
        const trimInfo = document.createElement('p');
        trimInfo.className = 'small text-muted mb-1';
        trimInfo.textContent = `Trim: ${cropData.start.toFixed(1)}s - ${cropData.end.toFixed(1)}s`;
        
        previewContent.appendChild(icon);
        previewContent.appendChild(trimInfo);
        
        if (isCroppingVideo) {
          const cropInfo = document.createElement('p');
          cropInfo.className = 'small text-muted';
          cropInfo.textContent = `Crop: ${cropData.width} x ${cropData.height}`;
          previewContent.appendChild(cropInfo);
        }
        
        cropPreview.appendChild(previewContent);
      }
    }

    // Play trim for video
    playTrimBtn.addEventListener('click', () => {
      if (currentVideo) {
        currentVideo.currentTime = cropData.start;
        currentVideo.play();
      }
    });

    // Reset video crop
    resetVideoCropBtn.addEventListener('click', () => {
      if (currentVideo && isCroppingVideo) {
        const videoRect = currentVideo.getBoundingClientRect();
        
        // Reset to full video
        cropArea.style.left = '0px';
        cropArea.style.top = '0px';
        cropArea.style.width = videoRect.width + 'px';
        cropArea.style.height = videoRect.height + 'px';
        
        // Update crop data
        const scaleX = currentVideo.videoWidth / videoRect.width;
        const scaleY = currentVideo.videoHeight / videoRect.height;
        
        cropData = {
          ...cropData,
          x: 0,
          y: 0,
          x2: currentVideo.videoWidth,
          y2: currentVideo.videoHeight,
          width: currentVideo.videoWidth,
          height: currentVideo.videoHeight
        };
        
        updateCropDisplay();
        updateCropPreview();
      }
    });

    // Reset crop for image
    document.getElementById('resetCrop').addEventListener('click', () => {
      if (cropper) {
        cropper.reset();
        const canvasData = cropper.getCanvasData();
        cropData = {
          x: Math.round(canvasData.left),
          y: Math.round(canvasData.top),
          x2: Math.round(canvasData.left + canvasData.width),
          y2: Math.round(canvasData.top + canvasData.height),
          width: Math.round(canvasData.width),
          height: Math.round(canvasData.height),
          start: 0,
          end: 0
        };
        updateCropDisplay();
        updateCropPreview();
      }
    });

    // Update preview in step 3
    function updatePreviewStep() {
      const formData = new FormData(document.getElementById('singleForm'));
      
      previewType.textContent = formData.get('type');
      previewLabel.textContent = formData.get('label');
      previewDescription.textContent = formData.get('description') || '-';
      
      // Prepare final crop data for submission
      let finalCropData = {};
      if (formData.get('type') === 'image') {
        finalCropData = {
          x: cropData.x,
          y: cropData.y,
          x2: cropData.x2,
          y2: cropData.y2
        };
      } else if (formData.get('type') === 'video') {
        finalCropData = {
          start: cropData.start,
          end: cropData.end
        };
        
        if (isCroppingVideo) {
          finalCropData.x = cropData.x;
          finalCropData.y = cropData.y;
          finalCropData.x2 = cropData.x2;
          finalCropData.y2 = cropData.y2;
        }
      }
      
      previewCropData.textContent = JSON.stringify(finalCropData, null, 2);
      
      // Update final preview
      finalPreview.innerHTML = '';
      
      if (formData.get('type') === 'image') {
        const img = document.createElement('img');
        img.src = currentFileUrl;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '400px';
        finalPreview.appendChild(img);
        
      } else {
        const video = document.createElement('video');
        video.src = currentFileUrl;
        video.controls = true;
        video.style.maxWidth = '100%';
        video.style.maxHeight = '400px';
        finalPreview.appendChild(video);
      }
      
      // Update crop overlay
      setTimeout(updateCropOverlay, 100);
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission
    document.getElementById('singleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Form submitting...');

      const type = typeSelect.value;

      let finalCropData = {};
      if (type === 'image') {
        finalCropData = {
          x: cropData.x || 0,
          y: cropData.y || 0,
          x2: cropData.x2 || 0,
          y2: cropData.y2 || 0
        };
      } else if (type === 'video') {
        finalCropData = {
          start: cropData.start || 0,
          end: cropData.end || 0
        };
        if (isCroppingVideo) {
          finalCropData.x = cropData.x || 0;
          finalCropData.y = cropData.y || 0;
          finalCropData.x2 = cropData.x2 || 0;
          finalCropData.y2 = cropData.y2 || 0;
        }
      }

      const cropDataInput = document.getElementById('cropData');
      cropDataInput.value = JSON.stringify(finalCropData);

      const formData = new FormData(document.getElementById('singleForm'));

      for (let [key, value] of formData.entries()) {
        console.log(`${key}:`, value);
      }

      if (!fileInput.files[0]) {
        console.error('No file selected!');
        alert('Vui lòng chọn một tệp trước khi gửi.');
        return;
      }

      formData.append('file', fileInput.files[0]);
      formData.append('crop_data', cropDataInput.value);

      console.log('File attached:', formData.get('file'));

      try {
        const response = await fetch('/add_single_sample', {
          method: 'POST',
          body: formData
        });

        console.log('Response status:', response.status);
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);

        const text = await response.text();
        console.log('Raw response:', text);

        let result;
        if (contentType && contentType.includes('application/json')) {
          result = JSON.parse(text);
        } else {
          // Xử lý HTML (nếu server trả về TemplateResponse)
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          const messageElement = doc.querySelector('.alert-success, .alert-danger');
          result = { message: messageElement ? messageElement.textContent : 'Unknown response' };
        }

        console.log('Server response:', result);
        if (response.ok) {
          alert(result.message || 'Gửi thành công!');
        } else {
          alert('Lỗi: ' + (result.detail ? result.detail[0].msg : result.message));
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        alert('Có lỗi khi gửi biểu mẫu: ' + error.message);
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set up step navigation
      step1.classList.add('active');
    });
    </script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>